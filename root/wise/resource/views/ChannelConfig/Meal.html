<span ng-include="'/resource/views/Common/nav.tpl.html'"></span>
<div class="p-md">
  <div class="box b-a bg-white m-b" ng-controller="MealController">
    <div class="col-md-10">
      <div class="panel-heading b-b b-light">{{arrayChannel.channel_name}}</div>
      <div class="panel-body">
        <p class="text-muted">{{channel_config_name}} <!--增加属性--><a class="pull-right fa fa-plus-square" ng-click="addArrtibute(channel_config_key, 0)"> </a></p>
        <div class="m-b-lg">
            <div class="m-b">   
				<!--菜式类别开始-->
                <div class="list-group no-radius" ng-if="channel_config_key=='cuisineCategory'">
                    <div class="list-group-item col-sm-3 m-xs"  ng-repeat="(i, item) in itemList">
                      <span class="pull-left w-xs m-r b-b-2x"><img class="img-responsive" width="90" height="90" ng-src="{{item.image_src}}"></span>
                      <div class="clear">
                        <span class="font-bold block">{{item.cuisine_name}}
                            <a><i class="glyphicon glyphicon-edit pull-right" ng-click="editItem(item.cuisine_id)"></i></a>
                        </span> 
                        特色:{{item.cuisine_specialty}}
                      </div>
                    </div>
                </div>
                <!--菜式类别结束-->
				<!--菜式开始-->
                <div class="list-group no-radius" ng-if="channel_config_key=='cuisine'">
                    <div class="list-group-item col-sm-3 m-xs"  ng-repeat="(i, item) in itemList">
                      <span class="pull-left w-xs m-r b-b-2x"><img class="img-responsive" width="90" height="90" ng-src="{{item.image_src}}"></span>
                      <div class="clear">
                        <span class="font-bold block">{{item.cuisine_name}}
                            <a><i class="glyphicon glyphicon-edit pull-right" ng-click="editItem(item.cuisine_id)"></i></a>
                        </span> 
                        特色:{{item.cuisine_specialty}}
                      </div>
                    </div>
                </div>
                <!--菜式结束-->
				<!--添加（房间|房型|菜式)按钮开始-->
                <div class="w-xl w-auto-xs">
                    <div class="box bg-white m-xs">
                      <div class="box-col w-auto-xs v-m">
                        <img ng-click="addArrtibute(channel_config_key, 0)" ng-src="{{__RESOURCE}}images/a10.jpg" width="120" height="120" class="b p-xs">
                      </div>
                      <div class="box-col p">
                        <a href="" class="pull-right fa fa-plus-square" ng-click="addArrtibute(channel_config_key, 0)"> 添加{{channel_config_name}}</a>
                        <div></div>
                      </div>
                    </div>
                </div>
                <!--添加（房间|房型|菜式）按钮结束-->
            </div>
        </div>
      </div>
    </div>
    <!--右边comom添加属性开始-->
    <div class="col-md-2 b-l no-border-sm">
      <div class="panel-heading b-b b-light" translate="module.channel.arrtibute">属性</div>
      <div class="list-group no-border no-radius" ng-repeat="(i, Arrtibute) in configArrtibute" ng-if="i==0">
        <div class="list-group-item" ng-repeat="(father_id, childen) in Arrtibute">
            <div class="m-b-xs">
            <!--<a class="pull-right ti-settings" ng-click="config(i)"></a>-->
            <i class="fa fa-fw fa-circle text-info"></i>
            {{childen.attribute_name}}
            </div>
            <ul class="m-l nav b-b" ng-repeat="(j, sub) in configArrtibute[father_id]">
            	<li class="p-xs">{{sub.attribute_name}}</li>
                <li class="col-md-5 p-xs m-l-xs" ng-repeat="(l, subChilden) in configArrtibute[sub.attribute_id]">
                    <span class="fa fa-angle-right fa-fw text-muted"></span> {{subChilden.attribute_name}}
                </li>
            </ul>
        </div>
      </div>
    </div>
    <!--右边添加属性结束-->
  </div>
</div>
<script language="JavaScript">
    app.controller('MealController', function($rootScope, $scope, $httpService, $location, $translate, $aside, $ocLazyLoad, $alert) {
		$scope.param = {};
		$ocLazyLoad.load([__RESOURCE+"editor/kindeditor/lang/zh-CN.js"]);
		var arrayAttribute = {};
		//获取数据
		var _channel = $scope.$stateParams.channel, common = '';
		var _view = $scope.$stateParams.view;
		var param = 'channel='+_channel+'&view='+_view;
		$scope.loading.show();
		$httpService.post('/app.do?'+param, $scope, function(result){
			$scope.loading.hide();
			if(result.data.success == '0') {
				var message = $scope.getErrorByCode(result.data.code);
				$alert({title: 'Error', content: message, templateUrl: '/modal-warning.html', show: true});
			}
			common = result.data.common;
			$scope.setCommonSetting(common);
			$scope.itemList            = result.data.item.itemList;
			$scope.arrayConfig         = result.data.item.arrayConfig;
			$scope.arrayChannel        = result.data.item.arrayChannel;
			$scope.arrayDefaultAttr    = result.data.item.arrayDefaultAttr;
			$scope.channel_config_key  = result.data.item.channel_config_key;
			$scope.channel_config_name = result.data.item.channel_config_name;
			$scope.channel_id          = result.data.item.channel_id;
			$scope.channel_config_url  = result.data.item.channel_config_url;
			$scope.imagesUploadUrl     = result.data.item.imagesUploadUrl;
			$scope.imagesManagerUrl    = result.data.item.imagesManagerUrl;
			if($scope.channel_config_key == 'cuisine') {
				$scope.itemCategoryList  = result.data.item.itemCategoryList;
			}
			
			arrayAttribute = result.data.item.arrayAttribute;
			var configArrtibute = {};
			if(arrayAttribute != '') {
				for(var i in arrayAttribute) {
					if(typeof(configArrtibute[arrayAttribute[i].attribute_father_id]) == 'undefined') 
						configArrtibute[arrayAttribute[i].attribute_father_id] = {};
					configArrtibute[arrayAttribute[i].attribute_father_id][arrayAttribute[i].attribute_id] = arrayAttribute[i];
				}
			}
			$scope.configArrtibute = configArrtibute;
			$(document).ready(function(){
				
			});
		});
		
		$scope.haveSelectRoom = {};$scope.attrSelectRoom = {};$scope.haveSelectImages = {};$scope.extend_attr = {};
		//begin commom 右边数据/////////////////////////////////////////////////////////////////////////////////////
		var myArrtibute = '';
		$scope.addArrtibute = function(key, param) {
			$scope.attrSelectRoom = {};$scope.haveSelectRoom = {};$scope.haveSelectImages = {};$scope.extend_attr = {};
			if(param == 0) {
				param = {};param["valid"] = "1";param["image_src"] = $scope._resource+'images/a10.jpg';
				//$('#selectRoom').remove();
			} else {
				var cuisine_id = param.cuisine_category_id, cuisine_name = '';
				for(var i in $scope.itemCategoryList) {
					if($scope.itemCategoryList[i].cuisine_id == cuisine_id) {
					   cuisine_name = $scope.itemCategoryList[i].cuisine_name;
					}
				}
				$scope.select_cuisineCategory = {'cuisine_id':cuisine_id,'cuisine_name':cuisine_name};
			} 
			$scope.param = param;
            myArrtibute = $aside({scope : $scope, title: $scope.arrayChannel.channel_name+$scope.channel_config_name, content: 'My Content', placement : 'top', animation : 'am-fade-and-slide-top', backdrop : "static", container: 'body', templateUrl: __RESOURCE+'views/ChannelConfig/'+key+'.tpl.html'});
            myArrtibute.$promise.then(function() {
				myArrtibute.show();
				$scope.setImage();
				$(document).ready(function(){
					if(typeof(param.cuisine_id) != 'undefined') $('input[name="cuisine_id"]').val(param.cuisine_id);
				});
            })
		};
        //end commom 右边数据///////////////////////////////////////////////////////////////////////////////////
        <!--common 编辑-->
		var continue_find = true;
		$scope.editItem = function(cuisine_id) {
			var itemList = $scope.itemList;
			continue_find = true;
			getItem(itemList, cuisine_id);
		};
		function getItem(itemList, cuisine_id) {
			if(continue_find == false) return;
			for(var i in itemList) {
				if(typeof(itemList[i].cuisine_name) != 'undefined') {
					if(itemList[i].cuisine_id == cuisine_id) {
						var param = itemList[i];
						continue_find = false;
						$scope.addArrtibute($scope.channel_config_key, param);
						//查找房型attr
						var arrt_param = '&cuisine_id='+cuisine_id
                        if($scope.channel_config_key=='cuisineCategory') {
							arrt_param = '&cuisine_category_id='+cuisine_id
						}	
						$scope.attrSelectRoom = {};$scope.haveSelectRoom = {};
						var loading = $alert({content: 'Saving... 80%', placement: 'top', type: 'info', templateUrl: '/loading.html', show: true});
						$httpService.header('method', 'attribute');
						var postParam = {};postParam.param = '';
						$httpService.post('app.do?channel='+$scope.channel_config_url+'&c_id='+$scope.channel_id+arrt_param, postParam, function(result){
							$httpService.deleteHeader('method');
							if(result.data.success == 1) {
								if(result.data.item != '') setAttribute(result.data.item);
							} 
							loading.hide();
						});
                        //
						break;
					}
				} else {
					getItem(itemList[i], cuisine_id)
				}
			}
		};
        <!--end common 编辑-->
        <!--common保存-->
		$scope.saveItem = function() {
			$scope.beginLoading =! $scope.beginLoading;
			var setItemForm = $.serializeFormat('#setItemForm');
			$scope.param = setItemForm;
			$httpService.header('method', 'save');
			var loading = $alert({content: 'Saving... 80%', placement: 'top', type: 'info', templateUrl: '/loading.html', show: true});
			$httpService.post('app.do?channel='+$scope.channel_config_url+'&c_id='+$scope.channel_id, $scope, function(result){
				$scope.beginLoading =! $scope.beginLoading;
				$httpService.deleteHeader('method');
				if(result.data.success == 1) {
					myArrtibute.hide();
					//$scope.itemList =  result.data.item;
				} 
				loading.hide();
			});
		};
        <!--end common保存-->
        <!--图片上传及操作-->
		//images
		var isSetImage = false;
		$scope.setImage = function() {
			//if(isSetImage) return;isSetImage = true;
			var uploadJsonUrl = 'app.do?channel='+$scope.imagesUploadUrl+'&channel_config='+$scope.channel_config_key;
			var fileManagerJsonUrl = 'app.do?channel='+$scope.imagesManagerUrl+'&channel_config='+$scope.channel_config_key;
			window.K = KindEditor;
			var editor = K.editor({
				uploadJson : uploadJsonUrl,
				fileManagerJson : fileManagerJsonUrl,
				allowFileManager : true
			});
			K('.set_image_src').click(function() {
				var isMain = $(this).attr('isMain');
				editor.loadPlugin('image', function() {
					editor.plugin.imageDialog({
						//imageUrl : K('#image_src').val(),
						clickFn : function(url, title, width, height, border, align) {
							editor.hideDialog();
							if(isMain == 1) {
								K('#image_src').val(url);
								$scope.setMainImages(url, title, width, height, border, align);
							} else {
								$scope.setSubImages(url, title);
							}
						}
					});
				});
			});
		}
		
		$scope.setMainImages = function (url, title, width, height, border, align) {
			$('#main_images').attr('src', url);
		}
		$scope.setSubImages = function (url, title) {
			if(title == '_del_images') {
				delete $scope.haveSelectImages[url];
			} else {
				$scope.haveSelectImages[url] = title;
			}
			$scope.$apply();
		}
        <!--图片上传及操作结束-->
		<!--属性编辑开始-->
		function setAttribute(arrayAttributeValue) {
			$scope.extend_attr = {};
			if(typeof(arrayAttributeValue['images']) != 'undefined') {
				var haveSelectImages = {};
				for(var i in arrayAttributeValue['images']) {
					haveSelectImages[arrayAttributeValue['images'][i]['cuisine_images_src']] = arrayAttributeValue['images'][i]['attr_value'];
				}
				$scope.haveSelectImages = haveSelectImages;
			}
			var extend_attr = {}, k = 0;
			if(typeof(arrayAttributeValue['attr_value']) != 'undefined') {
				$(document).ready(function(){
					for(var i in arrayAttributeValue['attr_value']) {
						var attributeValue = arrayAttributeValue['attr_value'][i];
						var attribute_id = attributeValue.attribute_id;
						var value = $.trim(attributeValue.attr_value);
						var attr_obj = $('.attr_value_'+attribute_id+'[value="'+value+'"]');
						var attr_type = attr_obj.attr('type');
						if(attr_type == 'checkbox' || attr_type == 'radio') {
							attr_obj.attr('checked', true);
						} else {
							if(typeof(arrayAttribute[attribute_id]) != 'undefined') {
								attr_type = arrayAttribute[attribute_id]['input_type'];
							}
							if(attr_type == 'extend_text') {
								if(typeof(extend_attr[attribute_id]) == 'undefined') extend_attr[attribute_id] = {};
								extend_attr[attribute_id][k] = attributeValue;k++;
							} else {
								$('.attr_value_'+attribute_id+'_0').val(value);
							}
						}
					}
					$scope.extend_attr = extend_attr; 
				});
			}
		}
		//
		$scope.attrExtend = function(attr_id) {
			//var attr_id = this.attr_id;
			var attr_count = $('.extend_text_'+attr_id).length;
			var html = '<label class="control-label checkbox-inline no-padding m-b-xs attr_extend">'
				+'<input class="form-control w-xxl" type="text" value="" name="attr_value['+attr_id+']['+attr_count+']"data-id="'+attr_count+'"></label>';
			$('#attr_extend').before(html);
		}
        <!--属性编辑结束-->
		//selectCategory
		$scope.selectCategory = function(selectCategory) {
			$scope.param.cuisine_category_id = selectCategory.cuisine_id;
			$scope.param.cuisine_category_name = selectCategory.cuisine_name;
		}
	});
	//
</script>

